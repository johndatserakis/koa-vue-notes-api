FROM node:10

ARG APP_EMAIL
ARG APP_NAME
ARG APP_PORT
ARG APP_URL
ARG DB_DATABASE
ARG DB_HOST
ARG DB_PASSWORD
ARG DB_PORT
ARG DB_USER
ARG IMAGE_TAG
ARG JWT_ACCESS_TOKEN_EXP
ARG JWT_SECRET
ARG NODE_ENV
ARG RECAPTCHA_SECRET
ARG SENDGRID_API_KEY

ENV APP_EMAIL=$APP_EMAIL \
    APP_NAME=$APP_NAME \
    APP_PORT=$APP_PORT \
    APP_URL=$APP_URL \
    DB_DATABASE=$DB_DATABASE \
    DB_HOST=$DB_HOST \
    DB_PASSWORD=$DB_PASSWORD \
    DB_PORT=$DB_PORT \
    DB_USER=$DB_USER \
    IMAGE_TAG=$IMAGE_TAG \
    JWT_ACCESS_TOKEN_EXP=$JWT_ACCESS_TOKEN_EXP \
    JWT_SECRET=$JWT_SECRET \
    NODE_ENV=$NODE_ENV \
    RECAPTCHA_SECRET=$RECAPTCHA_SECRET \
    SENDGRID_API_KEY=$SENDGRID_API_KEY

WORKDIR /usr/src/app

COPY package*.json ./

RUN npm install

RUN npm install knex -g

COPY . .

RUN npm run build

CMD [ "node", "app.js" ]
